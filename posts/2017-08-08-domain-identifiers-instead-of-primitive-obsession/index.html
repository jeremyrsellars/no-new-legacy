<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<!-- 2017-08-08 Domain Identifiers instead of Primitive Obsession.md 2017-08-08 -->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta charset="utf-8">
  <title>Domain Identifiers instead of &#39;Primitive Obsession&#39; - No New Legacy Code Blog - Jeremy Sellars</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, max-scale=1.0">
    <meta name="keywords" content="No New Legacy Code, #&lt;Ruhoh::Views::MasterView:0x000000068b3318&gt;,#&lt;Ruhoh::Views::MasterView:0x000000068b3318&gt;, #&lt;Ruhoh::Views::MasterView:0x000000068b3318&gt;,">
    <meta name="description" content="In strongly-typed programming paradigms, consider introducing domain identifier types instead of using primitives like strings.">
    <meta name="date" content="2017-08-08">
    <meta name="datePublished" content="2017-08-08">
    <meta name="revised" content="2018-09-07">
    <meta name="author" content="Jeremy Sellars">
    <meta name="geo.region" content="US-MO" />

<link href='/no-new-legacy/assets/stylesheets/bootstrap.min-82f77a9ca975e3765ed90050b04df670.css' type='text/css' rel='stylesheet' media='all'>
<link href='/no-new-legacy/assets/stylesheets/style-21784202ff2dd459e98edeb0ab87bf58.css' type='text/css' rel='stylesheet' media='all'>
<link href='/no-new-legacy/assets/stylesheets/google_prettify/sons-of-obsidian-1fc7bbae7ece7f100c56fc75a0e333cc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/no-new-legacy/assets/stylesheets/application-e3642abd8348ea2b5f7b414c30786006.css' type='text/css' rel='stylesheet' media='all'>
  <!-- http://www.favicon-generator.org/ -->
  <link rel="apple-touch-icon" sizes="57x57" href="/no-new-legacy/assets/media/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/no-new-legacy/assets/media/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/no-new-legacy/assets/media/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/no-new-legacy/assets/media/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/no-new-legacy/assets/media/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/no-new-legacy/assets/media/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/no-new-legacy/assets/media/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/no-new-legacy/assets/media/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/no-new-legacy/assets/media/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/no-new-legacy/assets/media/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/no-new-legacy/assets/media/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/no-new-legacy/assets/media/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/no-new-legacy/assets/media/favicon-16x16.png">
  <link rel="manifest" href="/no-new-legacy/assets/media/manifest.json">
  <meta name="msapplication-TileColor" content="#753636">
  <meta name="msapplication-TileImage" content="/no-new-legacy/assets/media/ms-icon-144x144.png">
  <meta name="theme-color" content="#753636">
  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
  <!--[if IE 6]><link href="default_ie6.css" rel="stylesheet" type="text/css" /><![endif]-->

  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-85077174-2']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>



</head>
<body itemscope="" itemtype="http://schema.org/WebPage">
<div id="header" tabindex="0" hidefocus="true">
  <div class="container">
    <div id="logo">
      <h1><a href="/no-new-legacy/">No New Legacy Code</a></h1>
    </div>
    <div id="menu">
      <ul class="nav">
          
            <li><a href="/no-new-legacy/archive">Archive</a></li>
          
          
            <li><a href="/no-new-legacy/tags">Tags</a></li>
          
          
            <li><a href="/no-new-legacy/categories">Categories</a></li>
          
          
            <li><a href="/no-new-legacy/pages">Pages</a></li>
          
      </ul>
    </div>
  </div>
</div>

<div id="wrapper">
  <div id="page" class="container">
    <div id="content" itemprop="mainContentOfPage">
      
<div class="page-header">
  <div class="span12">
    <h1>Domain Identifiers instead of &#39;Primitive Obsession&#39; </h1>
  </div>
</div>

<div class="post-full">
  <div class="span12">
    <div class="date">
      <span>2017-08-08</strong>
    </div>
    <div class="content">
      <p>Summary: In strongly-typed programming paradigms, consider introducing domain identifier types instead of using primitives like strings.</p>

<h3 id="toc_0">The Problem</h3>

<blockquote>
<p><a href="http://wiki.c2.com/?PrimitiveObsession"  target="_blank" title="" rel="noopener" class="external">Primitive Obsession</a> is using primitive data types to represent domain ideas.</p>
</blockquote>

<p>â€“ From Ward Cunningham&#39;s wiki.</p>

<p>In strongly-typed paradigms, this can be considered a &quot;code smell&quot;.  Of course, there are other paradigms and contexts, but in this post, I&#39;ll share an Object-Oriented opinion and assume we are discussing how to use a strongly-typed language, like C# or Java, to model the problem domain in &quot;plain old C# objects.&quot;</p>

<p>There are some reasons to consider avoiding the use of primitive types, but first, what&#39;s a primitive type?</p>

<h3 id="toc_1">What is a primitive type?</h3>

<p>A &quot;primitive&quot; is one of the building blocks your language provides.  This is mostly just the &quot;language&quot; (C#, Java), not the libraries, or even the standard library.  So primitives are things like <code>Integer</code>, <code>long</code>, <code>float</code>, <code>string</code>, etc..  Data structures, like maps and sets from a library might be called &quot;primitives&quot; for the purpose of this discussion if they are used to <em>represent</em> a domain object (instead of using a class).</p>

<p>To be clear, these primitives are essential for building software; the issue is using them to describe or model the domain or API.</p>

<h3 id="toc_2">Quick Example</h3>

<pre><code class="c-sharp">    var bodyMassIndex = CalculateBMI(36,   // Is that kg or pounds?
                                     300); // Inches, feet, centimeters?
    // and did I get the parameters in the right order?
</code></pre>

<p>(Ha ha, don&#39;t even get me started on why BMI isn&#39;t a good calculation to judge your health by, or that 98.6 F is a &quot;normal&quot; temperature.)</p>

<p>So, here we see some of the problems with using primitives as part of a method signature.  (Also, we see why languages with position-based argument lists can be problematic, but that&#39;s an issue for another day.)</p>

<p>So, what are some ways of addressing these problems?</p>

<p>You can create classes that indicate in the type signature what domain concept is being represented, in this case, unit of length.</p>

<pre><code class="c-sharp">    public class Length {
      public static Length FromInches(float inches) =&gt; new Length(inches * 2.54);
      public static Length FromCentimeters(int cm) =&gt; new Length(cm);
      private Length(float cm)// private constructor saves dimension
    }
</code></pre>

<p>This gives a nicer function signature.</p>

<pre><code class="c-sharp">    float CalculateBMI(Length height, Weight weight)
</code></pre>

<p>If your compiler is equipped with a type checker, you also get some help detecting out-of-order parameters.</p>

<pre><code class="c-sharp">    var weight = Weight.FromPounds(100);
    var height = Length.FromInches(100);
    var bmi = CalculateBMI(weight, height); // doesn&#39;t compile! Yeah!
</code></pre>

<h3 id="toc_3">Further Up and Further In</h3>

<p>So, what if we went further down the road of Object Oriented and make an BMICalculator object instead of a function.</p>

<pre><code class="c-sharp">    public class BMICalculator {
      public int HeightCM;
      public int WeightKG;
      public float CalculateBMI() =&gt; // do some math.
    }
</code></pre>

<p>Well, it&#39;s not pretty, but it works.</p>

<h3 id="toc_4">A Common Example: Entity Identifiers</h3>

<p>One of the consistent violators that I see quite often is the use of a primitive to identify an entity in the business model.  For example, a string like <code>Domain.Name=&quot;example.com&quot;</code>.  By using a primitive, you are left with the primitive type&#39;s equality semantics, hashcode calculation, and string representation.  So, while internet treats <code>&quot;example.com&quot; == &quot;EXAMPLE.COM&quot;</code> as the same, <code>System.String</code> does not.</p>

<p>To get around this, we&#39;ll often see conversion to a canonical version (e.g. normalized to lower case with <code>domain.ToLowerCase()</code>), or, more likely, <code>string.Compare(domain1, domain2, StringComparison.OrdinalIgnoreCase) == 0</code>.  Yuck!  </p>

<p>Yeah, I know.  Code reuse lets us &quot;Write it once and use it everywhere.&quot;  But really, does that work?  What about when you want to put it in a <code>Dictionary&lt;string, DomainEntry&gt;</code>?  Then the hashing system needs an appropriate hash code generator and an equality checker.</p>

<p>Then, assuming you&#39;ve written all of this, then you probably should train the team so they know which types/comparison/function/type to use.</p>

<p>Now, what if Joe and Sally choose different comparison?  What class of bugs can occur on French computers where lowercase works a bit differently?</p>

<p>So, this is can become a big issue.</p>

<h2 id="toc_5">Identity</h2>

<p>Here&#39;s a class that can make it easy to make Domain Identifiers instead of having &quot;<a href="http://wiki.c2.com/?PrimitiveObsession"  target="_blank" title="" rel="noopener" class="external">Primitive Obsession</a>&quot;</p>

<p>This is part of an attempt to use Domain Values and Identities instead of primitives like strings to make member signatures more informative.</p>

<p>It also attempts to reduce tedious-to-read and easy-to-screw-up boilerplate code.</p>

<pre><code class="c-sharp">    // Extend this to turn a primitive into a domain entity identifier
    public class Identity&lt;TSelf, TData&gt; : IEquatable&lt;TSelf&gt;
        where TSelf : Identity&lt;TSelf, TData&gt;
        where TData : IEquatable&lt;TData&gt;
    {
        public Identity(TData value)
        {
            if (ReferenceEquals(value, null))
                throw new ArgumentNullException(nameof(value));

            _value = value;
        }

        public virtual bool Equals(TSelf other); // elided

        public override bool Equals(object other) =&gt; Equals(other as TSelf);

        public sealed override int GetHashCode(); // implemented correctly and cached immutably.

        protected virtual int GetHashCodeCore() =&gt; Value.GetHashCode();

        public override string ToString(); elided

        // Value non-public so you can use a name that makes sense for your domain
        protected TData Value =&gt; _value;
    }

    // Extend this to make a composite key for a domain entity
    public class Identity&lt;TSelf, TData1, TData2&gt; : Identity&lt;TSelf, TData1&gt;
        where TSelf : Identity&lt;TSelf, TData1, TData2&gt;
        where TData1 : IEquatable&lt;TData1&gt;
        where TData2 : IEquatable&lt;TData2&gt;
    {
        // elided
    }
</code></pre>

<p>See <a href="#identity.cs" title="">full source</a> below.</p>

<blockquote>
<p>Let&#39;s break it down.</p>
</blockquote>

<ol>
<li>It introduces the semantic &quot;Identity&quot;

<ul>
<li>An atomic &quot;value/equatable&quot; reference type that can be used in (nearly) any idiomatic C# way to identify an entity.</li>
<li>Implementations should be immutable.</li>
<li>Note, unlike System.Tuple`1, this doesn&#39;t publicly expose the id field, implying that the extending class gets to use a name well-suited to the problem domain (instead of the inheritance hierarchy.)</li>
</ul></li>
<li>It introduces the semantic &quot;Identified&quot; (types which extend Identified) which 

<ul>
<li>A class that provides minimalist <code>GetHashCode</code> and <code>ToString</code> implementations.</li>
<li>Implementations should be immutable.</li>
<li>Note, unlike System.Tuple`1, this doesn&#39;t publicly expose the id field, implying that the extending class gets to use a name well-suited to the problem domain (instead of the inheritance hierarchy.)</li>
<li>Note, we may wish to introduce a <code>public interface IIdentified&lt;TIdentity&gt; {TIdentity Identity {get;}}</code> which Identified could implement privately.</li>
</ul></li>
<li>It introduces the semantic &quot;IdentifiedValue&quot; (types which extend IdentifiedValue)

<ul>
<li>A class that provides minimalist <code>GetHashCode</code> and <code>ToString</code> implementations and forces inheritor to implement an <code>Equals(T other)</code> which implies thorough value/equality semantics.</li>
<li>Implementations should be immutable.</li>
</ul></li>
</ol>

<p>Ramifications:</p>

<ol>
<li><p>Identities can be used safely and consistently in common idioms:</p>

<ul>
<li><code>Hashtable</code></li>
<li><code>Dictionary&lt;K,V&gt;</code></li>
<li><code>HashSet&lt;K&gt;</code></li>
<li><code>object a,b; a == b</code>;</li>
</ul></li>
<li><p>Entity &quot;Values&quot; can implement structural equality once in <code>EqualsCore</code> and benefit from &quot;better than System.Object&quot; default implementations from <code>GetHashCode</code>, <code>Equals</code>, and <code>ToString()</code>.</p></li>
<li><p>Entity objects benefit from &quot;better than System.Object&quot; default implementations of <code>GetHashCode</code>, and <code>ToString()</code>, and use <code>Object.Equals(object)</code> by default.</p></li>
<li><p>The inheritor gets to pick the name of the members (identity is protected, not public).</p></li>
</ol>

<h1 id="toc_6">Full Source</h1>

<p><a id="identity.cs"/></p>

<pre><code class="c-sharp">    public class Identity&lt;TSelf, TData&gt; : IEquatable&lt;TSelf&gt;
        where TSelf : Identity&lt;TSelf, TData&gt;
        where TData : IEquatable&lt;TData&gt;
    {
        private readonly TData _value;

        public Identity(TData value)
        {
            if (ReferenceEquals(value, null))
                throw new ArgumentNullException(nameof(value));

            _value = value;
        }

        public virtual bool Equals(TSelf other) =&gt;
            other != null
            &amp;&amp; Value.Equals(other.Value);

        public override bool Equals(object other) =&gt; Equals(other as TSelf);

        public sealed override int GetHashCode()
        {
            // GetHashCode is effectively a 31-bit hashcode
            // calculated from the Value, by default.

            // When this bit is set, then the code as already calculated.
            const int assignmentBit = 1 &lt;&lt; 15;

            // This lazy, lock-free implementation is thread-safe, assuming:
            // * The resulting hash code is the same regardless of which thread calculates it.
            // * Int32 fields can be assigned with a single operation.

            // ReSharper disable NonReadonlyMemberInGetHashCode
            var hc = _hashCode;
            if (hc == 0)
                _hashCode = hc = GetHashCodeCore() | assignmentBit;
            return hc;
        }

        protected virtual int GetHashCodeCore() =&gt; Value.GetHashCode();

        public override string ToString() =&gt;
            $&quot;{ShortTypeName}[{Value}]&quot;;

        protected TData Value =&gt; _value;

        [NonSerialized]
        private int _hashCode;

        protected static string ShortTypeName { get; } = typeof(TSelf).Name;
    }

    public class Identity&lt;TSelf, TData1, TData2&gt; : Identity&lt;TSelf, TData1&gt;
        where TSelf : Identity&lt;TSelf, TData1, TData2&gt;
        where TData1 : IEquatable&lt;TData1&gt;
        where TData2 : IEquatable&lt;TData2&gt;
    {
        private readonly TData2 _value2;

        public Identity(TData1 value, TData2 value2)
            : base(value)
        {
            if (ReferenceEquals(value2, null))
                throw new ArgumentNullException(nameof(value2));
            _value2 = value2;
        }

        protected TData2 Value2 =&gt; _value2;

        public override string ToString() =&gt;
            $&quot;{ShortTypeName}[{Value},{Value2}]&quot;;

        public override bool Equals(TSelf other) =&gt;
            other != null
            &amp;&amp; Value.Equals(other.Value)
            &amp;&amp; Value2.Equals(other.Value2);

        protected override int GetHashCodeCore()
        {
            var hash = 17;
            hash = hash * 23 + Value.GetHashCode();
            hash = hash * 23 + Value2.GetHashCode();
            return hash;
        }
    }
</code></pre>

    </div>
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      <li>
        <a href="/no-new-legacy/categories#Programming-ref">Programming <span>8</span></a>
      </li>
    </ul>
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      <li>
        <a href="/no-new-legacy/tags#domain design-ref">domain design <span>1</span></a>
      </li>
      <li>
        <a href="/no-new-legacy/tags#code smell-ref">code smell <span>1</span></a>
      </li>
    </ul>
    <hr>
    <div class="pagination">
      <ul>
          <li class="prev"><a href="/no-new-legacy/posts/2016-10-23-liskov-substitution-principal-and-the-pit-of-success" title="Liskov Substitution Principal and the Pit of Success">&larr; Previous</a></li>

          <li><a href="/no-new-legacy/archive">Archive</a></li>

          <li class="next"><a href="/no-new-legacy/posts/2018-09-07-generative-testing-introduction" title="Generative Testing Part 1 â€“ Introduction">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
    
  </div>
</div>


    </div>
  </div>
</div>

<div id="footer" itemscope="" itemtype="http://schema.org/LocalBusiness">
      <div class="footer">
        <p>&copy; <a href="https://github.com/jeremyrsellars" itemprop="copyrightHolder">Jeremy Sellars</a> <span itemprop="copyrightYear">2015 - 2018</span>
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
          <br>Theme based on <a href="https://templated.co/fullstrength" rel="nofollow" target="_blank">FullStrength</a> template from <a href="http://templated.co" rel="nofollow" target="_blank">TEMPLATED</a>

        </p>
      </div>

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->

</body>
</html>
